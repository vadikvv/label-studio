    location /label-studio/ {
            rewrite ^/label-studio/(.*) /$1 break;
            proxy_pass http://localhost:3030;
            
            # Header handling
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Origin $scheme://$host;
            proxy_set_header Referer $scheme://$host$request_uri;
            proxy_set_header X-CSRFToken $cookie_csrftoken;

            # Cookie handling
            proxy_cookie_path / /label-studio/;
            proxy_cookie_domain localhost $host;
            
            # Websocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Redirect handling
            proxy_redirect http://localhost:3030/ /label-studio/;
            proxy_redirect / /label-studio/;
            port_in_redirect off;

            # Content replacements
            sub_filter_once off;
            sub_filter_types *;

            sub_filter 'APP_SETTINGS.hostname.replace' 'location.origin.replace';

            # Original path replacements (keep these after the fix above)
            sub_filter '/static/' '/label-studio/static/';
            sub_filter '/react-app/' '/label-studio/react-app/';
            sub_filter '/prompt/' '/label-studio/prompt/';
            sub_filter '/projects/' '/label-studio/projects/';
            sub_filter 'action="/' 'action="/label-studio/';
            sub_filter 'href="/' 'href="/label-studio/';
            sub_filter 'url("/' 'url("/label-studio/';
            sub_filter 'src="/' 'src="/label-studio/';
            sub_filter '"url":"/' '"url":"/label-studio/';
            sub_filter "action='" "action='/label-studio/";
            sub_filter 'href=/' 'href=/label-studio/';

            # Service Worker fixes
            sub_filter 'navigator.serviceWorker.register("/sw.js")' 'navigator.serviceWorker.register("/label-studio/sw.js", {scope: "/label-studio/"})';
            sub_filter 'scope: "/"' 'scope: "/label-studio/"';
            sub_filter '"scope":"/"' '"scope":"/label-studio/"';
            sub_filter '/sw.js' '/label-studio/sw.js';

            # React Router and APP_SETTINGS fixes
            sub_filter 'hostname: ""' 'hostname: location.origin+"/label-studio/"';
            sub_filter '"url": "/' '"url": "/label-studio/';
    }

    # Add specific location for service worker
    location /label-studio/sw.js {
        rewrite ^/label-studio/(.*) /$1 break;
        proxy_pass http://localhost:3030;
        proxy_set_header Host $host;
        add_header Service-Worker-Allowed "/label-studio/";
        add_header Content-Type "application/javascript";
    }
        
    location /label-studio {
            return 301 $scheme://$host$uri/;
    }